# CXTB-23: Notifications Page Navigation
TestNotificationsPageNavigation:
  Environment: Settings
  Precases:
    - LoginNeverAloneHelper
  Roles:
    - Role: localiOS
      App: NeverAlone
  Actions:
  # In the Home page, click on the Bell icon and verify user is redirected to Notifications page.
    - Type: case
      Value: NotificationsPageNavigationHelper
  # Terminate the app.
    - Type: case
      Value: TerminateApp

# CXTB-22: Verify Notifications Page on Senior App
TestNotificationsPageOnSeniorApp:
  Environment: Settings
  Precases:
    - LoginNeverAloneHelper
  Aftercases:
    - TerminateApp
  Roles:
    - Role: localiOS
      App: NeverAlone
    - Role: desktopChrome
      App: desktop    
  Actions:
  # In the Home page, click on the Bell icon and verify user is redirected to Notifications page.
    - Type: case
      Value: NotificationsPageNavigationHelper
    - Type: sleep
      Time: 10
  # Get actual number of notifications.
    - Type: return_element_attribute
      Strategy: xpath
      Id: $PAGE.seniors_app_notifications.notifications_number_label$
      Attribute: label
      ResultVar: NOTIFICATIONS_NUMBER_LABEL
  # Verify that the number next to notifications header shows the number of the new notifications present.
  # Add a notification
    - Type: case
      Value: SetScheduledCallForSeniors
    - Type: wait_not_visible
      Strategy: class_chain
      Id: $PAGE.seniors_app_notifications.no_new_notification$
      Time: 10
  # Verify that there is one more since there was a new notification added on this run.
    - Type: sleep
      Time: 10
    - Type: operation
      Operation: "$AND_CLI_NOTIFICATIONS_NUMBER_LABEL$ + 1"
      ResultVar: UPDATED_NOTIFICATION_NUMBER_LABEL
    - Type: return_element_attribute
      Strategy: xpath
      Id: $PAGE.seniors_app_notifications.notifications_number_label$
      Attribute: label
      ResultVar: NOTIFICATIONS_NUMBER_LABEL
    - Type: assert
      Asserts:
        - Type: eq
          Var: UPDATED_NOTIFICATION_NUMBER_LABEL
          Value: $AND_CLI_NOTIFICATIONS_NUMBER_LABEL$
  # Click on the notification created on this run.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_notifications.appointment_based_on_name_element$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.appointment_header_modal$
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.close_btn$
    - Type: wait_not_visible
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.appointment_header_modal$
      Time: 10
  # Verify the notification is not appearing on the "New" tab anymore.
    - Type: wait_not_visible
      Strategy: class_chain
      Id: $PAGE.seniors_app_notifications.appointment_based_on_name_element$
      Time: 10
  # Click on "All" at the top of the page.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_notifications.all_tab$
  # Verify that the notification appears under the "All" tab.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_notifications.appointment_based_on_name_element$
  # Click on the notification.
  # This sleep is to reduce flakyness, if we assert by seconds then there are higher chances that test will fail.
  # With this sleep we will assert once it has passed a minute and the label says taht was added 1 minute ago.
    - Type: sleep
      Time: 55
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_notifications.appointment_based_on_name_element$
  # Verify user can see when it was sent.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.appointment_added_label$
    - Type: calculate_minutes_passed_by_from_event_creation
      Timestamp: $AND_CLI_EVENT_SENT_TIMESTAMP$
      ResultVar: ADDED_EVENT_X_TIME_AGO
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.appointment_added_label$
      Attribute: label
      ResultVar: APPOINTMENT_ADDED_X_TIME_AGO
    - Type: assert
      Asserts:
        - Type: eq
          Var: APPOINTMENT_ADDED_X_TIME_AGO
          Value: $AND_CLI_ADDED_EVENT_X_TIME_AGO$

# CXTB-31: Verify appointment added notifications
TestAppointmentAddedNotifications:
  Environment: Settings
  Precases:
    - LoginNeverAloneHelper
  Aftercases:
    - TerminateApp
  Roles:
    - Role: localiOS
      App: NeverAlone
    - Role: desktopChrome
      App: desktop    
  Actions:
  # In the Home page, click on the Bell icon and verify user is redirected to Notifications page.
    - Type: case
      Value: NotificationsPageNavigationHelper
    - Type: sleep
      Time: 10
  # Add manual appointment
    - Type: case
      Value: SetNonTelehealthAppointmentForSenior
  # Click on the notification created on this run.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_notifications.manual_appointment_based_on_name_element$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.appointment_header_modal$
  # Verify "Appointment Added" detail window opens, showing the related event details:
  # What, Date, Time, Where, Description.
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.appointment_header_modal$
      Attribute: label
      ResultVar: APPOINTMENT_HEADER_TEXT
    - Type: assert
      Asserts:
        - Type: eq
          Var: APPOINTMENT_HEADER_TEXT
          Value: Appointment Added
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.what_label$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.date_label$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.time_label$
    - Type: return_element_attribute
      Strategy: xpath
      Id: $PAGE.seniors_app_appointment_modal.time_value$
      Attribute: label
      ResultVar: TIME_VALUE
    - Type: assert
      Asserts:
        - Type: contain
          Var: TIME_VALUE
          Value: $AND_CLI_FUTURE_START_6MINUTES_FOR_COMPARISON$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.where_label$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.description_label$
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.close_btn$
    - Type: wait_not_visible
      Strategy: class_chain
      Id: $PAGE.seniors_app_appointment_modal.appointment_header_modal$
      Time: 10