#CXTB-170: Participant Page Navigation
#CXTB-171: Access Participant Directory & Filter
#CXTB-172: Can Click and View Participant Record from Listing
TestProviderAccessParticipantDirectoryandViewDeviceRecordfromListing:
  Environment: Settings 
  Roles:
    - Role: desktopChrome
      App: "desktop"
  Actions:
  # Log in Care Platform as an Provider
    - Type: case
      Value: ProvidersCarePlatformLogin
  # Go to Participants
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_home_page.participants_navigation$      
  # Get the value to compare.
    - Type: get_text
      Strategy: xpath
      Id: $PAGE.providers_participants_page.first_darkened_letter_button$
      Greps:
        - var: LASTNAME_FILTER_LETTER
          match: "(.*)"
  # Click the first darkened letter button.
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_page.first_darkened_letter_button$
  # Verify it was filtered by the selected letter.
    - Type: get_text
      Strategy: xpath
      Id: $PAGE.providers_participants_page.first_senior_lastname$
      Greps:
        - var: LASTNAME_FIRST_LETTER
          match: ^[a-zA-Z]  
    - Type: assert
      Asserts: 
      - Type: eq
        Var: LASTNAME_FIRST_LETTER
        Value: $AND_CLI_LASTNAME_FILTER_LETTER$
  # Remove the filter by clicking on the letter.
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_page.selected_darkened_letter_button$
  # Get the first lastname in the list.
    - Type: get_text
      Strategy: xpath
      Id: $PAGE.providers_participants_page.first_senior_lastname$
      Greps:
        - var: LASTNAME_FIRST_PARTICIPANT_NO_FILTER
          match: (.*)
  # Add the search filter.
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_page.search_button$
    - Type: send_keys
      Strategy: xpath
      Id: $PAGE.providers_participants_page.search_input$
      Value: $AND_CLI_LASTNAME_FIRST_PARTICIPANT_NO_FILTER$
  # Verify there is at least one participant with that name.
    - Type: wait_for
      Strategy: xpath
      Id: $PAGE.providers_participants_page.first_senior_lastname$
    - Type: get_text
      Strategy: xpath
      Id: $PAGE.providers_participants_page.first_senior_lastname$
      Greps:
        - var: LASTNAME_FIRST_PARTICIPANT
          match: (.*)
  # Clear the search by clicking small "x" on right of the field.
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_page.clear_search_button$
  # Verify there is at least one participant.
    - Type: wait_for
      Strategy: xpath
      Id: $PAGE.providers_participants_page.first_senior_lastname$
  # Click on a participant.
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_page.senior_1_row$
  # Verify that the info is showing after selecting the participant.
    - Type: wait_for
      Strategy: xpath
      Id: $PAGE.providers_participants_page.senior_1_row$
  # filter by status
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_page.status_dropdown_button$
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_page.status_dropdown_suspended$
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_page.status_dropdown_button$
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_page.status_dropdown_active$
  # Verify that the info is showing after selecting the filter.
    - Type: wait_for
      Strategy: xpath
      Id: $PAGE.providers_participants_page.senior_1_row$
  # CHS-2609 bug validation
  # Verify only "Health Overview", "Medication" and "Providers" tabs appear.
    - Type: wait_for
      Strategy: xpath
      Id: $PAGE.providers_participants_page.participant_details_tabs_nav_bar$
    - Type: count_elements
      Strategy: xpath
      Id: $PAGE.providers_participants_page.participant_details_tabs_nav_bar_items$
      ResultVar: TABS_COUNT
    - Type: assert
      Asserts:
        - Type: eq
          Var: TABS_COUNT
          Value: "3"
    - Type: get_attribute
      Strategy: xpath
      Id: $PAGE.providers_participants_page.participant_details_tabs_nav_bar$
      Greps:
      - var: TABS
        attr: textContent
        condition: nempty
        match: "(.*)"
    - Type: assert
      Asserts:
      - Type: contain
        Var: TABS
        Value: 'Health Overview'
      - Type: contain
        Var: TABS
        Value: 'Medication'
      - Type: contain
        Var: TABS
        Value: 'Providers'
  # Click on Records Button
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_page.records_button$
  # Click to Demographics Tab
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_records_page.demographics_tab$ 
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_records_page.demographics_vendors_subtab$ 
  # Click to Medical Tab
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_records_page.medical_tab$
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_records_page.medications_subtab$
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_records_page.medical_needs_subtab$
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_records_page.medical_behavioral_subtab$
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_records_page.medical_history_subtab$
  # Click to Call History Tab
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_records_page.call_history_tab$
  # Click to Emergency Calls tab
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_records_page.emergency_calls_tab$
 # Click to Follow-up Tickets Tab
    - Type: click
      Strategy: xpath
      Id: $PAGE.providers_participants_records_page.follow_up_tickets_tab$

# CXTB-123 Answer Call from Queue & Navigate to Info Pages in Platform While on Call
TestProviderBrowsingWhileOnCall:
  Environment: Settings
  Precases:
    - LoginNeverAloneHelper
    - SeniorCleanPrompts
    - ProviderNewCleaner
    - CarePartnerCleanCallQueueAndHangedCalls
  Aftercases:
    - TerminateApp
  Roles:
    - Role: localiOS
      App: NeverAlone
    - Role: desktopChrome
      App: desktop
    - Role: desktopChrome1
      App: desktop
  Actions:
  # Generate a medical call as a senior.
    - Type: case
      Value: CallCarePartner
      Role: localiOS
  # Login and answer call as a care partner,
    - Type: case
      Value: AnswerCallAsCarePartner
      Role: desktopChrome
  # Care Partner makes the medical transfer for the provider to join
    - Type: case
      Value: MakeMedicalTransferWhileOnCall
      Role: desktopChrome
  # Log in as a provider and join the call
    - Type: case
      Value: ProvidersCarePlatformLogin
      Role: desktopChrome1
    - Type: case
      Value: JoinMedicalTransfer
      Role: desktopChrome1
    - Type: wait_for
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.video_btn$
      Role: desktopChrome1
  # Go into the records
    - Type: click
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_call_portal.call_participant_records$
  # Checking fixed video 
    - Type: wait_for
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_floating_video_call.video_fixed_content$
  # Red indicator for 'In session'
    - Type: get_attribute
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_header.status_indicator$
      Greps:
        - var: INDICATOR
          attr: class
          condition: nempty
          match: "(.*)"
    - Type: assert
      Role: desktopChrome1
      Asserts:
        - Type: contain
          Var: INDICATOR
          Value: 'is-red'
  # Click around
    - Type: click
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_participant_records.medical_tab$
    - Type: get_attribute
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_participant_records.medical_tab$
      Greps:
        - var: ACTIVE_CLASS
          attr: class
          condition: nempty
          match: "(.*)"
    - Type: assert
      Role: desktopChrome1
      Asserts:
        - Type: contain
          Var: ACTIVE_CLASS
          Value: 'active' 
  # Checking fixed video 
    - Type: wait_for
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_floating_video_call.video_fixed_content$
    - Type: click
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_participant_records.call_history_tab$
    - Type: click
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_participant_records.emergency_calls_tab$
    - Type: click
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_participant_records.follow_up_tickets_tab$
    - Type: wait_for
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_participant_records.call_history_title$
  # Checking fixed video 
    - Type: wait_for
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_floating_video_call.video_fixed_content$
  # Check on Hide button
    - Type: click
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_floating_video_call.video_hide_button$
    - Type: get_attribute
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_floating_video_call.video_fixed_content$
      Greps:
        - var: VIDEO_CLASS
          attr: class
          condition: nempty
          match: "(.*)"
    - Type: assert
      Role: desktopChrome1
      Asserts:
        - Type: contain
          Var: VIDEO_CLASS
          Value: 'app-video-hidden'
    - Type: wait_for
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_floating_video_call.video_show_button$
  # Show video again
    - Type: click
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_floating_video_call.video_show_button$
    - Type: get_attribute
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_floating_video_call.video_fixed_content$
      Greps:
        - var: VIDEO_CLASS
          attr: class
          condition: nempty
          match: "(.*)"
    - Type: assert
      Role: desktopChrome1
      Asserts:
        - Type: n_contain
          Var: VIDEO_CLASS
          Value: 'app-video-hidden'
    - Type: wait_for
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_floating_video_call.video_hide_button$
  # Hover over the video tile
    - Type: wait_for
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_floating_video_call.video_fixed_content$
    - Type: hover
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_floating_video_call.video_fixed_content$
    - Type: click
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_floating_video_call.video_return_span$
      Condition:
      - Value: 2
        Operation: visible
        Result: true
    - Type: wait_not_visible
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_floating_video_call.video_fixed_content$
      Time: 5
  # End Call
    - Type: click
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_call_portal.leave_call_btn$
    - Type: get_attribute
      Strategy: xpath
      Role: desktopChrome1
      Id: $PAGE.care_platform_call_portal.video_status$
      Greps:
        - var: CALL_MESSAGE
          attr: textContent
          condition: nempty
          match: "(.*)"
    - Type: assert
      Role: desktopChrome1
      Asserts:
        - Type: contain
          Var: CALL_MESSAGE
          Value: 'The call has ended'
  # Fill survey as Care Partner
    - Type: case
      Value: PostCallSurveyCarePartner
      Role: desktopChrome
  # Complete Notes as Provider
    - Type: case
      Value: ProviderCompleteSession
      Role: desktopChrome1

# CXTB-178: Call Participant’s Device & Complete an On-Demand Call.
TestProviderCallParticipantAndCompleteOnDemandCall:
  Environment: Settings
  Vars:
  # Log out option
    LOGOUT_OPTION: "Go Off Shift"
    USER_FULLNAME: $AND_CLI_provider_user1_name$ $AND_CLI_provider_user1_lastname$
    STAFF_ROLE: "Provider"
  Precases:
    - LoginNeverAloneHelper
    - ProviderNewCleaner
    - SeniorCleanPrompts
  # Commented until they fix the refresh
  #  - AdminOnCallRefreshStaff
  Aftercases:
    - TerminateApp
  Roles:
    - Role: localiOS
      App: NeverAlone
    - Role: desktopChrome
      App: desktop
  Actions:
  # Call Participant logged in as a Provider.
    - Type: case
      Value: ProviderCallParticipant
  # Device begins ringing and automatically displays "Incoming Call" modal.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.incoming_call_header$
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.incoming_call_header$
      Attribute: label
      ResultVar: HEADER_TITLE
    - Type: assert
      Asserts:
        - Type: eq
          Var: HEADER_TITLE
          Value: Incoming Call...
  # Verify that it shows who is calling and their details, giving you the option to answer or ignore the call.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.called_name$
    - Type: return_element_attribute
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.called_name$
      Attribute: label
      ResultVar: CALLER_VALUE
    - Type: assert
      Asserts:
        - Type: contain
          Var: CALLER_VALUE
          Value: $AND_CLI_provider_user1_name$ $AND_CLI_provider_user1_lastname$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.answer_call_button$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.ignore_call_button$
  # Click "Answer Call" button.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_incoming_call.answer_call_button$
  # Verify that senior was connected to the call.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.video_button$
  # Then click "End Call".
    - Type: click
      Strategy: class_chain
      Id: $PAGE.seniors_app_call.end_call_button$
  # Select the Great option on the Post Call Survey once the call ends.
    - Type: case
      Value: SeniorGreatPostSurveyCallHelper
  # Fill up the Post Call Survey on the provider side.
    - Type: case
      Value: PostCallSurveyProvider
  # Verify that the Provider is no longer showing as "In Session (red dot)".
    - Type: wait_for
      Strategy: xpath
      Role: desktopChrome
      Id: $PAGE.care_platform_header.status_indicator$
    - Type: return_element_attribute
      Strategy: xpath
      Role: desktopChrome
      Id: $PAGE.care_platform_header.status_indicator$
      Attribute: className
      ResultVar: IS_RED
    - Type: assert
      Asserts:
        - Type: n_contain
          Var: IS_RED
          Value: is-red
