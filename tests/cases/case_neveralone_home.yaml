GetCallRecordings:
  ParallelRoles: true
  Roles:
    - Role: command1
      App: command
  Actions:
    - Type: command
      Role: command1
      Value: mkdir -p $AND_CLI_TEST_FOLDER$
    - Type: sync
    - Type: command
      Value: "ffmpeg -y -f avfoundation -t $AND_CLI_TIME$ -framerate 30 -probesize 42M  -pix_fmt uyvy422 -i \"$AND_CLI_VIDEO_IN$:\" $AND_CLI_TEST_FOLDER$/output.mp4"
      Role: command1
    - Type: sync

AnalyzeRecordings:
  ParallelRoles: true
  Roles:
    - Role: command1
      App: command
  Actions:
    # Get bit rate
    - Type: command
      Value: "ffprobe -v error -select_streams v:0 -show_entries stream=bit_rate -of default=noprint_wrappers=1:nokey=1 $AND_CLI_TEST_FOLDER$/output.mp4"
      Role: command1
      Greps:
        - var: BIT_RATE
          match: "(.*)"
    # Get count of frames
    - Type: command
      Value: "ffprobe -v error -select_streams v:0 -show_entries stream=nb_frames -of default=noprint_wrappers=1:nokey=1 $AND_CLI_TEST_FOLDER$/output.mp4"
      Role: command1
      Greps:
        - var: FRAME_COUNT
          match: "(.*)"   
    # Get pixel count of video (resolution)
    - Type: command
      Value: "ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of csv=s=x:p=0 $AND_CLI_TEST_FOLDER$/output.mp4"
      Role: command1
      Greps:
        - var: VIDEO_PIXEL_COUNT
          match: "(.*)"   
    # Get average frame rate
    - Type: command
      Value: "ffprobe -v error -select_streams v:0 -show_entries stream=avg_frame_rate -of default=noprint_wrappers=1:nokey=1 $AND_CLI_TEST_FOLDER$/output.mp4"
      Role: command1
      Greps:
        - var: AVG_FRAME_RATE
          match: "(.*)"   
    - Type: sync


# CXTB-70: Verify Call Personal Care Partner Button on Page
TestCallPersonalCarePartnerOnHomePage:
  Vars:
    TIME: 5
    INTERFACE: en0
    VIDEO_IN: "1"
    TEST_FOLDER: $AND_CMD_pwd$/Reports/executions/$AND_CMD_date +%s$
  Environment: Settings
  Precases:
    - LoginNeverAloneHelper
  Aftercases:
    - TerminateApp
  Roles:
    - Role: localiOS
      App: NeverAlone
    - Role: desktopChrome
      Capabilities:
        chromeOptions:
          args:
            - use-fake-ui-for-media-stream
            - use-fake-device-for-media-stream
            - use-file-for-fake-audio-capture=$AND_CMD_pwd$/video_audio_samples/sample3.wav
            - use-file-for-fake-video-capture=$AND_CMD_pwd$/video_audio_samples/sample_640x360.mjpeg
            - no-sandbox
            - disable-gpu
      App: desktop
    - Role: command1
      App: command
  Actions:
    # Login to the Care Platform app with Care Partners account.
    - Type: case
      Value: CarePartnerLogin
    # Click on the Call Personal Care Partner button.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.never_alone_home.call_care_partner$
    # Verify that the screen updates to show screen asking what kinf of heelp you need:
    # Medical 
    # Non-Medical
    # Cancel Call
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_call.medical_call_button$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_call.non_medical_call_button$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_call.cancel_call_button$
    # Click on the Cancel Call button and verify that Home page is displayed.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.never_alone_call.cancel_call_button$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_home.call_care_partner$
    # Click on the Call Personal Care Partner button again.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.never_alone_home.call_care_partner$
    # Click on the Non Medical call button.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.never_alone_call.non_medical_call_button$
    # Verify that screen redirects to the call waiting room.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_call.waiting_room_label$
    - Type: click
      Strategy: class_chain
      Id: $PAGE.never_alone_call.video_button$

    ## Care partner steps to take the call.
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_home.first_call_of_queue$
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_home.answer_call$
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.video_btn$
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.video_mirror_care_partner$
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.full_screen_call_btn$
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.verify_video_is_full_screen$
    - Type: click #workaround
      Strategy: xpath
      Id: $PAGE.never_alone_call.mute_call_button$
    - Type: click
      Strategy: xpath
      Id: $PAGE.never_alone_call.mute_call_button$
    # Record the call.
    - Type: case
      Value: GetCallRecordings
    - Type: click #workaround
      Strategy: xpath
      Id: $PAGE.never_alone_call.mute_call_button$
    # Analyze the call.
    - Type: case
      Value: AnalyzeRecordings
    # Assert that bit rate is greater than 1.5 kbps.
    - Type: assert
      Asserts:
        - Type: gt
          Var: BIT_RATE
          Value: 1500000 #low rate
    # Assert that frame count is framerate * seconds (150 on this case is the most accurate)
    # Let's give ffmpeg a margin o 1 seconds so it's expected to record betweeen 4~6 seconds.
    - Type: assert
      Asserts:
        - Type: ge
          Var: FRAME_COUNT
          Value: 120 #minimum for 4 seconds.
    - Type: assert
      Asserts:
        - Type: le
          Var: FRAME_COUNT
          Value: 180 #maximum for 6 seconds.
    # Assert that pixel count (resolution) of the video is 3584x2240.
    - Type: assert
      Asserts:
        - Type: eq
          Var: VIDEO_PIXEL_COUNT
          Value: "3584x2240"
    # Assert that the average frame rate is 30/1
    - Type: assert
      Asserts:
        - Type: eq
          Var: AVG_FRAME_RATE
          Value: "30/1"
    - Type: click # workaround
      Strategy: xpath
      Id: $PAGE.never_alone_call.mute_call_button$
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.full_screen_call_btn$

    # Care partner leaves the call.
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.leave_call_btn$
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.leave_call_btn$
    # Select the Bad option on the Post Survey screen.
    - Type: click
      Strategy: xpath
      Id: $PAGE.never_alone_post_call_survey.bad_answer_button$
    # Verify page updates to ask why you made your selection and presents you with a set of reasons, or gives you option to return to main survey page.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_post_call_survey.video_quality_not_good_option$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_post_call_survey.could_not_hear_audio_option$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_post_call_survey.problem_was_not_solved_option$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_post_call_survey.issue_with_care_partner_option$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_post_call_survey.call_was_not_answered_option$
    # Click on the back to select button.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.never_alone_post_call_survey.back_to_select_button$
    # Select the Ok option.
    - Type: click
      Strategy: xpath
      Id: $PAGE.never_alone_post_call_survey.ok_answer_button$
    # Verify page updates to ask why you made your selection and presents you with a set of reasons, or gives you option to return to main survey page.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_post_call_survey.video_quality_not_good_option$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_post_call_survey.could_not_hear_audio_option$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_post_call_survey.problem_was_not_solved_option$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_post_call_survey.issue_with_care_partner_option$
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_post_call_survey.call_was_not_answered_option$
    # Click on the back to select button.
    - Type: click
      Strategy: class_chain
      Id: $PAGE.never_alone_post_call_survey.back_to_select_button$
    # Select the Great option.
    - Type: click
      Strategy: xpath
      Id: $PAGE.never_alone_post_call_survey.great_answer_button$
    # Verify page updates and shows Thank You for you feedback page.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_post_call_survey.thank_you_label$
    # Do not click the "To Home" button on Thank you for your feedback screen.
    - Type: sleep
      Time: 8
    # Verify device is automatically returned to home page after a few seconds.
    - Type: wait_for
      Strategy: class_chain
      Id: $PAGE.never_alone_home.call_care_partner$

    # End the call on care partner side - Teardown.
    # Fill the notes
    - Type: send_keys
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.providers_call_queue_page.subject_input$
      Value: Missed Call Subject Automation
    - Type: send_keys
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.providers_call_queue_page.details_textarea$
      Value: Missed Call Details Automation     
    - Type: wait_for_property
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.complete_session_btn$ 
      Property: disabled
      Value: "false"
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.complete_session_btn$             
    # Fill the Post-call Survey
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.non_medical_radiobtn$
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.non_medical_radiobtn$             
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.issue_resolved_yes_radiobutton$          
    - Type: click
      Role: desktopChrome
      Strategy: id
      Id: $PAGE.care_platform_call_portal.category_select$
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.medical_question_option$
    - Type: click
      Role: desktopChrome
      Strategy: id
      Id: $PAGE.care_platform_call_portal.subcategory_select$
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.located_provider_option$
    - Type: click
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_call_portal.submit_and_exit_session_button$
    - Type: wait_for
      Role: desktopChrome
      Strategy: xpath
      Id: $PAGE.care_platform_notifications.call_completed_notification$